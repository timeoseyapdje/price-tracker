<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>PriceTrack</title>
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Space+Grotesk:wght@400;500;600&display=swap"
    rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0a0c0f;
      --bg2: #0f1318;
      --bg3: #141920;
      --bg4: #1a2230;
      --border: #1e2d3d;
      --border2: #253545;
      --text: #c8d8e8;
      --text2: #7a9ab5;
      --text3: #4a6a85;
      --green: #00d4a4;
      --red: #ff4b6e;
      --blue: #4d9fff;
      --yellow: #ffd166;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    html {
      font-size: 14px
    }

    body {
      font-family: 'Space Grotesk', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      padding: 0 16px;
      position: sticky;
      top: 0;
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 50px
    }

    .logo {
      font-family: 'JetBrains Mono', monospace;
      font-size: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px
    }

    .logo span {
      color: var(--green)
    }

    .logo-icon {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, var(--green), var(--blue));
      border-radius: 7px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px
    }

    .header-r {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .live-badge {
      display: flex;
      align-items: center;
      gap: 5px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--green);
      background: rgba(0, 212, 164, .1);
      border: 1px solid rgba(0, 212, 164, .3);
      padding: 3px 9px;
      border-radius: 20px
    }

    .live-dot {
      width: 5px;
      height: 5px;
      background: var(--green);
      border-radius: 50%;
      animation: pulse 1.5s infinite
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: .3
      }
    }

    .clock {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text3)
    }

    /* ‚îÄ‚îÄ Notif banner ‚îÄ‚îÄ */
    #notif-banner {
      display: none;
      background: rgba(0, 212, 164, .12);
      border-bottom: 1px solid rgba(0, 212, 164, .3);
      padding: 8px 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--green);
      cursor: pointer;
      text-align: center
    }

    #notif-banner button {
      background: rgba(0, 212, 164, .2);
      border: 1px solid rgba(0, 212, 164, .4);
      color: var(--green);
      border-radius: 4px;
      padding: 2px 10px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      cursor: pointer;
      margin-left: 8px
    }

    /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
    .tabs {
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      display: flex;
      padding: 0 16px
    }

    .tab {
      padding: 12px 16px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text3);
      cursor: pointer;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: color .15s
    }

    .tab:hover {
      color: var(--text)
    }

    .tab.active {
      color: var(--text);
      border-bottom-color: var(--green)
    }

    @media(max-width:480px) {
      .tab span {
        display: none
      }

      .tab {
        padding: 12px 14px;
        font-size: 16px
      }
    }

    /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
    main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 14px
    }

    .section {
      display: none
    }

    .section.active {
      display: block
    }

    /* ‚îÄ‚îÄ Ticker ‚îÄ‚îÄ */
    .ticker-wrap {
      overflow: hidden;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 14px;
      position: relative;
      height: 34px
    }

    .ticker-wrap::before,
    .ticker-wrap::after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      width: 40px;
      z-index: 2;
      pointer-events: none
    }

    .ticker-wrap::before {
      left: 0;
      background: linear-gradient(to right, var(--bg2), transparent)
    }

    .ticker-wrap::after {
      right: 0;
      background: linear-gradient(to left, var(--bg2), transparent)
    }

    .ticker {
      display: flex;
      gap: 24px;
      animation: scroll 40s linear infinite;
      white-space: nowrap;
      padding: 0 16px;
      height: 100%;
      align-items: center;
      width: max-content
    }

    @keyframes scroll {
      0% {
        transform: translateX(0)
      }

      100% {
        transform: translateX(-50%)
      }
    }

    .ti {
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px
    }

    .ti-r {
      color: var(--text2)
    }

    .ti-p {
      color: var(--text);
      font-weight: 700
    }

    .ti-c {
      font-size: 10px;
      font-weight: 600
    }

    /* ‚îÄ‚îÄ Search bar ‚îÄ‚îÄ */
    .search {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end
    }

    .fg {
      display: flex;
      flex-direction: column;
      gap: 5px;
      flex: 1;
      min-width: 130px
    }

    .fl {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text3)
    }

    .sel,
    .din {
      background: var(--bg3);
      border: 1px solid var(--border2);
      border-radius: 7px;
      color: var(--text);
      padding: 8px 12px;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 13px;
      outline: none;
      -webkit-appearance: none;
      width: 100%
    }

    .sel:focus,
    .din:focus {
      border-color: var(--green)
    }

    .sbtn {
      background: linear-gradient(135deg, var(--green), #00b890);
      color: #0a0c0f;
      border: none;
      border-radius: 7px;
      padding: 8px 20px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      height: 38px;
      align-self: flex-end;
      white-space: nowrap
    }

    /* ‚îÄ‚îÄ Watchlist ‚îÄ‚îÄ */
    .watchlist {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 14px;
      overflow: hidden
    }

    .wl-head {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      font-weight: 600;
      color: var(--text2);
      display: flex;
      justify-content: space-between;
      align-items: center
    }

    .wl-items {
      display: flex;
      overflow-x: auto;
      scrollbar-width: none
    }

    .wl-items::-webkit-scrollbar {
      display: none
    }

    .wl-item {
      flex-shrink: 0;
      padding: 10px 16px;
      border-right: 1px solid var(--border);
      cursor: pointer;
      min-width: 120px;
      transition: background .15s
    }

    .wl-item:hover {
      background: var(--bg3)
    }

    .wl-item:last-child {
      border-right: none
    }

    .wl-route {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      color: var(--text3);
      text-transform: uppercase;
      margin-bottom: 3px
    }

    .wl-price {
      font-family: 'JetBrains Mono', monospace;
      font-size: 15px;
      font-weight: 700
    }

    .wl-chg {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      margin-top: 1px
    }

    /* ‚îÄ‚îÄ Chart area ‚îÄ‚îÄ */
    .chart-area {
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: 14px;
      margin-bottom: 14px
    }

    @media(max-width:860px) {
      .chart-area {
        grid-template-columns: 1fr
      }
    }

    .chart-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden
    }

    .chart-hdr {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px
    }

    .chart-ttl {
      font-size: 14px;
      font-weight: 600
    }

    .chart-sub {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--text3);
      margin-top: 2px
    }

    .price-disp {
      text-align: right
    }

    .cur-price {
      font-family: 'JetBrains Mono', monospace;
      font-size: 24px;
      font-weight: 700;
      line-height: 1
    }

    .price-chg {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      margin-top: 3px
    }

    .chart-body {
      padding: 12px;
      height: 260px;
      position: relative
    }

    .chart-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text3);
      gap: 8px;
      font-size: 13px
    }

    .chart-empty .ei {
      font-size: 36px;
      opacity: .3
    }

    /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1px
    }

    .sidebar-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden
    }

    .sb-hdr {
      padding: 10px 14px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--text3);
      text-transform: uppercase;
      letter-spacing: .8px;
      background: var(--bg3);
      border-bottom: 1px solid var(--border)
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 9px 14px;
      border-bottom: 1px solid rgba(30, 45, 61, .5)
    }

    .stat-row:last-child {
      border-bottom: none
    }

    .slabel {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--text3)
    }

    .sval {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      font-weight: 600
    }

    .ob-row {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      padding: 5px 14px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      border-bottom: 1px solid rgba(30, 45, 61, .4)
    }

    .ob-ask {
      color: var(--red)
    }

    .ob-bid {
      color: var(--green);
      text-align: right
    }

    .ob-mid {
      color: var(--text3);
      text-align: center;
      font-size: 9px
    }

    /* ‚îÄ‚îÄ Route grid (compact) ‚îÄ‚îÄ */
    .sec-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--text3);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 10px;
      padding-bottom: 7px;
      border-bottom: 1px solid var(--border)
    }

    .route-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 8px
    }

    .rc {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 9px;
      padding: 10px 12px;
      cursor: pointer;
      transition: all .15s;
      position: relative;
      overflow: hidden
    }

    .rc::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--border2);
      transition: background .15s
    }

    .rc:hover {
      transform: translateY(-1px);
      border-color: var(--border2)
    }

    .rc:hover::before,
    .rc.sel::before {
      background: var(--green)
    }

    .rc.sel {
      border-color: rgba(0, 212, 164, .35)
    }

    .rc-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px
    }

    .rc-name {
      font-size: 12px;
      font-weight: 600
    }

    .rc-arrow {
      color: var(--text3);
      font-size: 11px
    }

    .rc-price {
      font-family: 'JetBrains Mono', monospace;
      font-size: 16px;
      font-weight: 700
    }

    .rc-spark {
      height: 28px;
      margin-bottom: 6px
    }

    .rc-foot {
      display: flex;
      justify-content: space-between;
      align-items: center
    }

    .rc-badge {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600
    }

    .rc-badge.up {
      background: rgba(0, 212, 164, .12);
      color: var(--green);
      border: 1px solid rgba(0, 212, 164, .25)
    }

    .rc-badge.dn {
      background: rgba(255, 75, 110, .12);
      color: var(--red);
      border: 1px solid rgba(255, 75, 110, .25)
    }

    .rc-hl {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      color: var(--text3)
    }

    /* ‚îÄ‚îÄ Tech section ‚îÄ‚îÄ */
    .tech-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-bottom: 14px
    }

    @media(max-width:700px) {
      .tech-grid {
        grid-template-columns: 1fr
      }
    }

    .tech-cat {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden
    }

    .tc-hdr {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--bg3)
    }

    .tc-icon {
      width: 26px;
      height: 26px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px
    }

    .tc-icon.gpu {
      background: rgba(77, 159, 255, .2)
    }

    .tc-icon.ram {
      background: rgba(255, 209, 102, .2)
    }

    .tc-name {
      font-size: 13px;
      font-weight: 600
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    thead tr {
      border-bottom: 1px solid var(--border)
    }

    th {
      padding: 7px 12px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      color: var(--text3);
      text-transform: uppercase;
      letter-spacing: .5px;
      text-align: left;
      background: var(--bg3)
    }

    th:last-child,
    td:last-child {
      text-align: right;
      padding-right: 12px
    }

    td {
      padding: 9px 12px;
      font-size: 12px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background .12s
    }

    tr:last-child td {
      border-bottom: none
    }

    tr:hover td {
      background: var(--bg3)
    }

    .td-name {
      font-weight: 500
    }

    .td-price {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      font-size: 13px
    }

    .td-chg {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      font-weight: 600
    }

    .td-spark {
      width: 64px
    }

    /* ‚îÄ‚îÄ Colors ‚îÄ‚îÄ */
    .up {
      color: var(--green)
    }

    .dn {
      color: var(--red)
    }

    /* ‚îÄ‚îÄ Flash ‚îÄ‚îÄ */
    @keyframes fg {

      0%,
      100% {
        background: transparent
      }

      50% {
        background: rgba(0, 212, 164, .07)
      }
    }

    @keyframes fr {

      0%,
      100% {
        background: transparent
      }

      50% {
        background: rgba(255, 75, 110, .07)
      }
    }

    .fu {
      animation: fg .4s ease
    }

    .fd {
      animation: fr .4s ease
    }

    /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
    .spin {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid var(--border2);
      border-top-color: var(--green);
      border-radius: 50%;
      animation: sp .7s linear infinite
    }

    @keyframes sp {
      to {
        transform: rotate(360deg)
      }
    }

    @media(max-width:600px) {
      main {
        padding: 10px
      }

      .chart-body {
        height: 200px
      }

      .route-grid {
        grid-template-columns: 1fr 1fr
      }

      .cur-price {
        font-size: 18px
      }

      .clock {
        display: none
      }
    }
  </style>
</head>

<body>

  <header>
    <div class="logo">
      <div class="logo-icon">üìà</div>Price<span>Track</span>
    </div>
    <div class="header-r">
      <div class="live-badge">
        <div class="live-dot"></div>LIVE
      </div>
      <div class="clock" id="clock">--:--:--</div>
    </div>
  </header>

  <div id="notif-banner">
    üîî Activez les notifications pour √™tre alert√© quand les prix baissent !
    <button onclick="requestNotifPermission()">Activer</button>
    <button onclick="document.getElementById('notif-banner').style.display='none'"
      style="background:transparent;border-color:rgba(0,212,164,.2)">‚úï</button>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('trains')" id="tab-trains">üöÑ <span>Trains France</span></button>
    <button class="tab" onclick="switchTab('tech')" id="tab-tech">üíª <span>GPU & RAM</span></button>
  </div>

  <main>

    <!-- ‚ïê‚ïê TRAINS ‚ïê‚ïê -->
    <div class="section active" id="section-trains">

      <div class="search">
        <div class="fg">
          <div class="fl">D√©part</div><select class="sel" id="sel-from" onchange="updateTo()">
            <option value="">Choisir...</option>
          </select>
        </div>
        <div class="fg">
          <div class="fl">Arriv√©e</div><select class="sel" id="sel-to">
            <option value="">Choisir...</option>
          </select>
        </div>
        <div class="fg" style="max-width:160px">
          <div class="fl">Date</div><input type="date" class="din" id="travel-date">
        </div>
        <button class="sbtn" onclick="searchTrain()">üìä Tracker</button>
      </div>

      <div class="ticker-wrap">
        <div class="ticker" id="ticker">‚è≥ Chargement...</div>
      </div>

      <div class="watchlist">
        <div class="wl-head"><span>‚≠ê Watchlist</span><span id="last-update"
            style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3)"></span></div>
        <div class="wl-items" id="wl-items">
          <div style="padding:14px;color:var(--text3)">
            <div class="spin"></div>
          </div>
        </div>
      </div>

      <div class="chart-area">
        <div class="chart-card">
          <div class="chart-hdr">
            <div>
              <div class="chart-ttl" id="chart-ttl">S√©lectionnez une route</div>
              <div class="chart-sub" id="chart-sub">√âvolution en temps r√©el</div>
            </div>
            <div class="price-disp" id="price-disp" style="display:none">
              <div class="cur-price" id="cur-price">‚Äî</div>
              <div class="price-chg" id="price-chg"></div>
            </div>
          </div>
          <div class="chart-body">
            <canvas id="mainChart" style="display:none"></canvas>
            <div class="chart-empty" id="chart-empty">
              <div class="ei">üöÑ</div><span>Cliquez sur une route</span>
            </div>
          </div>
        </div>

        <div class="sidebar-card">
          <div class="sb-hdr">Statistiques</div>
          <div id="stats">
            <div class="stat-row"><span class="slabel">Ouverture</span><span class="sval" id="s-open">‚Äî</span></div>
            <div class="stat-row"><span class="slabel">Plus haut</span><span class="sval up" id="s-high">‚Äî</span></div>
            <div class="stat-row"><span class="slabel">Plus bas</span><span class="sval dn" id="s-low">‚Äî</span></div>
            <div class="stat-row"><span class="slabel">Actuel</span><span class="sval" id="s-cur">‚Äî</span></div>
            <div class="stat-row"><span class="slabel">Variation</span><span class="sval" id="s-chg">‚Äî</span></div>
            <div class="stat-row"><span class="slabel">Var. %</span><span class="sval" id="s-pct">‚Äî</span></div>
          </div>
          <div class="sb-hdr">Carnet d'ordres</div>
          <div id="ob">
            <div
              style="padding:10px 14px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text3);text-align:center">
              S√©lectionnez une route</div>
          </div>
        </div>
      </div>

      <div class="sec-title">Toutes les routes</div>
      <div class="route-grid" id="route-grid">
        <div style="padding:20px;color:var(--text3)">
          <div class="spin"></div>
        </div>
      </div>

    </div>

    <!-- ‚ïê‚ïê TECH ‚ïê‚ïê -->
    <div class="section" id="section-tech">

      <div class="chart-card" style="margin-bottom:14px">
        <div class="chart-hdr">
          <div>
            <div class="chart-ttl" id="tech-ttl">S√©lectionnez un composant</div>
            <div class="chart-sub" id="tech-sub">√âvolution en temps r√©el</div>
          </div>
          <div class="price-disp" id="tech-price-disp" style="display:none">
            <div class="cur-price" id="tech-cur-price">‚Äî</div>
            <div class="price-chg" id="tech-price-chg"></div>
          </div>
        </div>
        <div class="chart-body">
          <canvas id="techChart" style="display:none"></canvas>
          <div class="chart-empty" id="tech-chart-empty">
            <div class="ei">üñ•Ô∏è</div><span>Cliquez sur un composant</span>
          </div>
        </div>
      </div>

      <div class="tech-grid">
        <div class="tech-cat">
          <div class="tc-hdr">
            <div class="tc-icon gpu">üéÆ</div>
            <div class="tc-name">Cartes Graphiques</div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Mod√®le</th>
                <th>Prix</th>
                <th>Var.</th>
                <th class="td-spark">7j</th>
              </tr>
            </thead>
            <tbody id="gpu-body">
              <tr>
                <td colspan="4" style="padding:16px;text-align:center">
                  <div class="spin"></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="tech-cat">
          <div class="tc-hdr">
            <div class="tc-icon ram">üíæ</div>
            <div class="tc-name">M√©moire RAM</div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Mod√®le</th>
                <th>Prix</th>
                <th>Var.</th>
                <th class="td-spark">7j</th>
              </tr>
            </thead>
            <tbody id="ram-body">
              <tr>
                <td colspan="4" style="padding:16px;text-align:center">
                  <div class="spin"></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </main>

  <script>
    // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const cache = {};           // route/product data cache
    const sparkCharts = {};     // sparkline chart instances
    let mainChart = null;
    let techChart = null;
    let selRoute = null;
    let selTech = null;
    let allRoutes = [];
    let notifEnabled = false;
    const prevPrices = {};      // for drop detection

    const WATCHLIST = ['PARIS-LYON', 'PARIS-MARSEILLE', 'PARIS-BORDEAUX', 'PARIS-NICE', 'PARIS-LILLE'];
    const GPU = ['RTX 4090', 'RTX 4080', 'RTX 4070 Ti', 'RTX 4070', 'RX 7900 XTX', 'RX 7900 XT'];
    const RAM = ['DDR5 32GB 6000MHz', 'DDR5 16GB 6000MHz', 'DDR4 32GB 3200MHz', 'DDR4 16GB 3200MHz'];

    // ‚îÄ‚îÄ Clock ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    setInterval(() => {
      document.getElementById('clock').textContent = new Date().toLocaleTimeString('fr-FR');
    }, 1000);

    // ‚îÄ‚îÄ Notifications ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function checkNotifSupport() {
      if ('Notification' in window && Notification.permission === 'default') {
        document.getElementById('notif-banner').style.display = 'block';
      } else if (Notification.permission === 'granted') {
        notifEnabled = true;
      }
    }

    function requestNotifPermission() {
      Notification.requestPermission().then(perm => {
        notifEnabled = perm === 'granted';
        document.getElementById('notif-banner').style.display = 'none';
        if (notifEnabled) sendNotif('PrixTrack activ√© üéâ', 'Vous recevrez des alertes quand les prix baissent !', 'üìâ');
      });
    }

    function sendNotif(title, body, icon = 'üìâ') {
      if (!notifEnabled || Notification.permission !== 'granted') return;
      try {
        new Notification(title, { body, icon: '/favicon.ico', badge: '/favicon.ico', tag: 'prixtrack' });
      } catch (e) { }
    }

    function checkPriceDrop(label, currentPrice, type = 'train') {
      const key = `${type}:${label}`;
      const prev = prevPrices[key];
      if (prev !== undefined) {
        const drop = prev - currentPrice;
        const pct = (drop / prev * 100);
        if (drop > 0 && pct >= 2) { // Alert on ‚â•2% drop
          sendNotif(
            `üìâ Prix en baisse ‚Äî ${label}`,
            `${prev.toFixed(2)}‚Ç¨ ‚Üí ${currentPrice.toFixed(2)}‚Ç¨ (‚àí${pct.toFixed(1)}%)`,
          );
        }
      }
      prevPrices[key] = currentPrice;
    }

    // ‚îÄ‚îÄ Fetch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function get(url) {
      const r = await fetch(url);
      return r.json();
    }

    // ‚îÄ‚îÄ Tab switch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function switchTab(t) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
      document.getElementById(`section-${t}`).classList.add('active');
      document.getElementById(`tab-${t}`).classList.add('active');
      if (t === 'tech') loadTech();
    }

    // ‚îÄ‚îÄ Chart factory ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function makeChart(ctx, history) {
      const prices = history.map(d => d.price);
      const labels = history.map(d => new Date(d.time).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }));
      const isUp = prices[prices.length - 1] >= prices[0];
      const lc = isUp ? '#00d4a4' : '#ff4b6e';

      return new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            data: prices, borderColor: lc, borderWidth: 2,
            fill: true, tension: 0.3, pointRadius: 0, pointHoverRadius: 3,
            backgroundColor: ctx2 => {
              const g = ctx2.chart.ctx.createLinearGradient(0, 0, 0, ctx2.chart.height);
              g.addColorStop(0, isUp ? 'rgba(0,212,164,.18)' : 'rgba(255,75,110,.18)');
              g.addColorStop(1, 'rgba(0,0,0,0)');
              return g;
            }
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          animation: { duration: 200 },
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#141920', borderColor: '#1e2d3d', borderWidth: 1,
              titleColor: '#7a9ab5', bodyColor: '#c8d8e8',
              titleFont: { family: 'JetBrains Mono', size: 10 },
              bodyFont: { family: 'JetBrains Mono', size: 12, weight: 'bold' },
              callbacks: { label: c => ` ${c.raw.toFixed(2)} ‚Ç¨` }
            }
          },
          scales: {
            x: { grid: { color: 'rgba(30,45,61,.4)', drawBorder: false }, ticks: { color: '#4a6a85', font: { family: 'JetBrains Mono', size: 9 }, maxTicksLimit: 7, maxRotation: 0 }, border: { display: false } },
            y: { position: 'right', grid: { color: 'rgba(30,45,61,.4)', drawBorder: false }, ticks: { color: '#4a6a85', font: { family: 'JetBrains Mono', size: 9 }, callback: v => `${v.toFixed(0)}‚Ç¨`, maxTicksLimit: 5 }, border: { display: false } }
          }
        }
      });
    }

    // Minimal sparkline ‚Äî no animation, no tooltip, fast
    function makeSpark(canvas, prices, isUp) {
      const id = canvas.id;
      if (sparkCharts[id]) { sparkCharts[id].destroy(); }
      const c = canvas.getContext('2d');
      sparkCharts[id] = new Chart(c, {
        type: 'line',
        data: { labels: prices.map((_, i) => i), datasets: [{ data: prices, borderColor: isUp ? '#00d4a4' : '#ff4b6e', borderWidth: 1.5, fill: false, tension: 0.3, pointRadius: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: false }, tooltip: { enabled: false } }, scales: { x: { display: false }, y: { display: false } } }
      });
    }

    // ‚îÄ‚îÄ Update chart data without destroy ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function patchChart(chart, history) {
      const prices = history.map(d => d.price);
      const labels = history.map(d => new Date(d.time).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }));
      const isUp = prices[prices.length - 1] >= prices[0];
      const lc = isUp ? '#00d4a4' : '#ff4b6e';
      chart.data.labels = labels;
      chart.data.datasets[0].data = prices;
      chart.data.datasets[0].borderColor = lc;
      chart.data.datasets[0].backgroundColor = ctx2 => {
        const g = ctx2.chart.ctx.createLinearGradient(0, 0, 0, ctx2.chart.height);
        g.addColorStop(0, isUp ? 'rgba(0,212,164,.18)' : 'rgba(255,75,110,.18)');
        g.addColorStop(1, 'rgba(0,0,0,0)');
        return g;
      };
      chart.update('none');
    }

    // ‚îÄ‚îÄ Routes init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function init() {
      checkNotifSupport();

      // Load all data in one batch call
      const [routes, allData] = await Promise.all([
        get('/api/routes'),
        get('/api/trains-batch')
      ]);
      allRoutes = routes;

      routes.forEach(r => { cache[r.id] = allData[r.id]; });

      // Populate selects
      const cities = [...new Set(routes.flatMap(r => [r.from, r.to]))].sort();
      const fromSel = document.getElementById('sel-from');
      cities.forEach(c => fromSel.add(new Option(c, c)));

      const tmr = new Date(); tmr.setDate(tmr.getDate() + 1);
      document.getElementById('travel-date').value = tmr.toISOString().split('T')[0];

      buildTicker();
      buildWatchlist();
      buildRouteGrid();

      // Auto select first
      if (routes.length) loadRouteChart(routes[0].id);

      // Refresh every 15s
      setInterval(refresh, 15000);
    }

    function updateTo() {
      const from = document.getElementById('sel-from').value;
      const toSel = document.getElementById('sel-to');
      toSel.innerHTML = '<option value="">Choisir...</option>';
      if (!from) return;
      allRoutes.filter(r => r.from === from || r.to === from).forEach(r => {
        toSel.add(new Option(r.from === from ? r.to : r.from, r.id));
      });
    }

    function searchTrain() {
      const v = document.getElementById('sel-to').value;
      if (!v) return;
      loadRouteChart(v);
    }

    // ‚îÄ‚îÄ Batch refresh ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function refresh() {
      try {
        const allData = await get('/api/trains-batch');
        let hasDrops = false;
        allRoutes.forEach(r => {
          if (!allData[r.id]) return;
          const prev = cache[r.id];
          cache[r.id] = allData[r.id];

          // Check for drop notification
          const d = allData[r.id];
          checkPriceDrop(r.id.replace('-', ' ‚Üí '), d.current, 'train');

          // Update card DOM
          const priceEl = document.getElementById(`cp-${r.id}`);
          const badgeEl = document.getElementById(`cb-${r.id}`);
          if (priceEl) {
            const isUp = d.change >= 0;
            priceEl.textContent = `${d.current.toFixed(2)}‚Ç¨`;
            priceEl.className = `rc-price ${isUp ? 'up' : 'dn'}`;
            if (badgeEl) {
              badgeEl.className = `rc-badge ${isUp ? 'up' : 'dn'}`;
              badgeEl.textContent = `${isUp ? '‚ñ≤' : '‚ñº'} ${Math.abs(d.changePercent)}%`;
            }
            if (prev && Math.abs(d.current - prev.current) > 0.01) {
              const card = document.getElementById(`rc-${r.id}`);
              if (card) { card.classList.add(isUp ? 'fu' : 'fd'); setTimeout(() => card.classList.remove('fu', 'fd'), 400); }
            }
          }

          // Update watchlist
          const wp = document.getElementById(`wp-${r.id}`), wc = document.getElementById(`wc-${r.id}`);
          if (wp) {
            const isUp = d.change >= 0;
            wp.textContent = `${d.current.toFixed(2)}‚Ç¨`;
            wp.className = `wl-price ${isUp ? 'up' : 'dn'}`;
            wc.className = `wl-chg ${isUp ? 'up' : 'dn'}`;
            wc.textContent = `${isUp ? '‚ñ≤' : '‚ñº'} ${Math.abs(d.changePercent)}%`;
          }
        });

        // Update main chart if open
        if (selRoute && mainChart && cache[selRoute]) {
          const d = cache[selRoute];
          patchChart(mainChart, d.history);
          const isUp = d.change >= 0;
          document.getElementById('cur-price').textContent = `${d.current.toFixed(2)}‚Ç¨`;
          document.getElementById('cur-price').className = `cur-price ${isUp ? 'up' : 'dn'}`;
          document.getElementById('price-chg').innerHTML = `<span class="${isUp ? 'up' : 'dn'}">${isUp ? '‚ñ≤' : '‚ñº'} ${Math.abs(d.change).toFixed(2)}‚Ç¨ (${isUp ? '+' : ''}${d.changePercent}%)</span>`;
          updateStats(d);
        }

        buildTicker();
        document.getElementById('last-update').textContent = `M√†j ${new Date().toLocaleTimeString('fr-FR')}`;
      } catch (e) { console.error(e); }
    }

    // ‚îÄ‚îÄ Ticker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildTicker() {
      const items = Object.entries(cache).map(([id, d]) => {
        const isUp = d.change >= 0;
        return `<span class="ti"><span class="ti-r">${id.replace('-', '‚Üí')}</span><span class="ti-p">${d.current.toFixed(0)}‚Ç¨</span><span class="ti-c ${isUp ? 'up' : 'dn'}">${isUp ? '‚ñ≤' : '‚ñº'}${Math.abs(d.changePercent)}%</span></span>`;
      }).join('');
      const t = document.getElementById('ticker');
      t.innerHTML = items + items; // duplicate for seamless loop
    }

    // ‚îÄ‚îÄ Watchlist ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildWatchlist() {
      const c = document.getElementById('wl-items');
      c.innerHTML = WATCHLIST.map(id => {
        const d = cache[id]; if (!d) return '';
        const isUp = d.change >= 0;
        return `<div class="wl-item" onclick="loadRouteChart('${id}')">
      <div class="wl-route">${id.replace('-', '‚Üí')}</div>
      <div class="wl-price ${isUp ? 'up' : 'dn'}" id="wp-${id}">${d.current.toFixed(2)}‚Ç¨</div>
      <div class="wl-chg ${isUp ? 'up' : 'dn'}" id="wc-${id}">${isUp ? '‚ñ≤' : '‚ñº'} ${Math.abs(d.changePercent)}%</div>
    </div>`;
      }).join('');
    }

    // ‚îÄ‚îÄ Route grid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildRouteGrid() {
      const grid = document.getElementById('route-grid');
      grid.innerHTML = '';

      allRoutes.forEach(route => {
        const d = cache[route.id]; if (!d) return;
        const isUp = d.change >= 0;
        const card = document.createElement('div');
        card.className = 'rc'; card.id = `rc-${route.id}`;
        card.innerHTML = `
      <div class="rc-top">
        <div class="rc-name">${route.from} <span class="rc-arrow">‚Üí</span> ${route.to}</div>
        <div class="rc-price ${isUp ? 'up' : 'dn'}" id="cp-${route.id}">${d.current.toFixed(2)}‚Ç¨</div>
      </div>
      <canvas class="rc-spark" id="sp-${route.id}" height="28"></canvas>
      <div class="rc-foot">
        <span class="rc-badge ${isUp ? 'up' : 'dn'}" id="cb-${route.id}">${isUp ? '‚ñ≤' : '‚ñº'} ${Math.abs(d.changePercent)}%</span>
        <span class="rc-hl">H:${d.high.toFixed(0)}‚Ç¨ B:${d.low.toFixed(0)}‚Ç¨</span>
      </div>`;
        card.onclick = () => loadRouteChart(route.id);
        grid.appendChild(card);

        // Defer sparklines ‚Äî use requestIdleCallback if available
        const drawSpark = () => {
          const cv = document.getElementById(`sp-${route.id}`);
          if (cv) makeSpark(cv, d.history.slice(-15).map(h => h.price), isUp);
        };
        if ('requestIdleCallback' in window) requestIdleCallback(drawSpark);
        else setTimeout(drawSpark, 100);
      });
    }

    // ‚îÄ‚îÄ Load main chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadRouteChart(routeId) {
      selRoute = routeId;

      document.querySelectorAll('.rc').forEach(c => c.classList.remove('sel'));
      const ac = document.getElementById(`rc-${routeId}`);
      if (ac) ac.classList.add('sel');

      // Use cache if available, otherwise fetch
      let d = cache[routeId];
      if (!d) {
        d = await get(`/api/train/${routeId}`);
        cache[routeId] = d;
      }

      const [from, to] = routeId.split('-');
      document.getElementById('chart-ttl').textContent = `${from} ‚Üí ${to}`;
      document.getElementById('chart-sub').textContent = `${d.history.length} points ‚Äî en direct`;
      document.getElementById('price-disp').style.display = 'block';

      const isUp = d.change >= 0;
      document.getElementById('cur-price').textContent = `${d.current.toFixed(2)}‚Ç¨`;
      document.getElementById('cur-price').className = `cur-price ${isUp ? 'up' : 'dn'}`;
      document.getElementById('price-chg').innerHTML = `<span class="${isUp ? 'up' : 'dn'}">${isUp ? '‚ñ≤' : '‚ñº'} ${Math.abs(d.change).toFixed(2)}‚Ç¨ (${isUp ? '+' : ''}${d.changePercent}%)</span>`;

      updateStats(d);
      buildOrderBook(d.current);

      const cv = document.getElementById('mainChart');
      cv.style.display = 'block';
      document.getElementById('chart-empty').style.display = 'none';

      if (mainChart) { mainChart.destroy(); mainChart = null; }
      mainChart = makeChart(cv.getContext('2d'), d.history);
    }

    function updateStats(d) {
      document.getElementById('s-open').textContent = `${d.open.toFixed(2)}‚Ç¨`;
      document.getElementById('s-high').textContent = `${d.high.toFixed(2)}‚Ç¨`;
      document.getElementById('s-low').textContent = `${d.low.toFixed(2)}‚Ç¨`;
      document.getElementById('s-cur').textContent = `${d.current.toFixed(2)}‚Ç¨`;
      const isUp = d.change >= 0;
      document.getElementById('s-chg').innerHTML = `<span class="${isUp ? 'up' : 'dn'}">${isUp ? '+' : ''}${d.change.toFixed(2)}‚Ç¨</span>`;
      document.getElementById('s-pct').innerHTML = `<span class="${isUp ? 'up' : 'dn'}">${isUp ? '+' : ''}${d.changePercent}%</span>`;
    }

    function buildOrderBook(price) {
      let h = '';
      for (let i = 4; i >= 1; i--) { const a = price + i * (Math.random() * 1.5 + .5), q = Math.floor(Math.random() * 6 + 1); h += `<div class="ob-row"><span class="ob-ask">${a.toFixed(2)}‚Ç¨</span><span class="ob-mid">${q}√ó</span><span></span></div>`; }
      h += `<div class="ob-row" style="background:rgba(77,159,255,.06);border-color:rgba(77,159,255,.2)"><span style="color:var(--blue);font-weight:700">${price.toFixed(2)}‚Ç¨</span><span class="ob-mid" style="color:var(--blue)">actuel</span><span></span></div>`;
      for (let i = 1; i <= 4; i++) { const b = price - i * (Math.random() * 1.5 + .5); if (b < 0) continue; const q = Math.floor(Math.random() * 6 + 1); h += `<div class="ob-row"><span></span><span class="ob-mid">${q}√ó</span><span class="ob-bid">${b.toFixed(2)}‚Ç¨</span></div>`; }
      document.getElementById('ob').innerHTML = h;
    }

    // ‚îÄ‚îÄ Tech ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadTech() {
      const data = await get('/api/tech');
      buildTechTable('gpu-body', GPU, data);
      buildTechTable('ram-body', RAM, data);

      // Check drops
      Object.entries(data).forEach(([product, d]) => {
        checkPriceDrop(product, d.current, 'tech');
      });

      if (selTech) updateTechChartData(data[selTech]);
    }

    function buildTechTable(tbodyId, models, data) {
      const tbody = document.getElementById(tbodyId);
      tbody.innerHTML = '';
      models.forEach(m => {
        const d = data[m]; if (!d) return;
        const isUp = d.change >= 0;
        const key = m.replace(/\s+/g, '-');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="td-name">${m}</td><td class="td-price ${isUp ? 'up' : 'dn'}">${d.current.toFixed(2)}‚Ç¨</td><td class="td-chg ${isUp ? 'up' : 'dn'}">${isUp ? '‚ñ≤' : '‚ñº'} ${Math.abs(d.changePercent)}%</td><td class="td-spark"><canvas id="ts-${key}" height="28"></canvas></td>`;
        tr.onclick = () => loadTechChart(m, d);
        tbody.appendChild(tr);
        const drawSpark = () => {
          const cv = document.getElementById(`ts-${key}`);
          if (cv) makeSpark(cv, d.history.slice(-15).map(h => h.price), isUp);
        };
        if ('requestIdleCallback' in window) requestIdleCallback(drawSpark);
        else setTimeout(drawSpark, 80);
      });
    }

    async function loadTechChart(product, data) {
      selTech = product;
      if (!data) data = (await get('/api/tech'))[product];

      document.getElementById('tech-ttl').textContent = product;
      document.getElementById('tech-sub').textContent = `${data.history.length} points ‚Äî en direct`;
      document.getElementById('tech-price-disp').style.display = 'block';

      const isUp = data.change >= 0;
      document.getElementById('tech-cur-price').textContent = `${data.current.toFixed(2)}‚Ç¨`;
      document.getElementById('tech-cur-price').className = `cur-price ${isUp ? 'up' : 'dn'}`;
      document.getElementById('tech-price-chg').innerHTML = `<span class="${isUp ? 'up' : 'dn'}">${isUp ? '‚ñ≤' : '‚ñº'} ${Math.abs(data.change).toFixed(2)}‚Ç¨ (${isUp ? '+' : ''}${data.changePercent}%)</span>`;

      const cv = document.getElementById('techChart');
      cv.style.display = 'block';
      document.getElementById('tech-chart-empty').style.display = 'none';

      if (techChart) { techChart.destroy(); techChart = null; }
      techChart = makeChart(cv.getContext('2d'), data.history);
    }

    function updateTechChartData(data) {
      if (!techChart || !data) return;
      patchChart(techChart, data.history);
      const isUp = data.change >= 0;
      document.getElementById('tech-cur-price').textContent = `${data.current.toFixed(2)}‚Ç¨`;
      document.getElementById('tech-price-chg').innerHTML = `<span class="${isUp ? 'up' : 'dn'}">${isUp ? '‚ñ≤' : '‚ñº'} ${Math.abs(data.change).toFixed(2)}‚Ç¨ (${isUp ? '+' : ''}${data.changePercent}%)</span>`;
    }

    // ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    init().catch(console.error);
  </script>
</body>

</html>